# nodejsé‡è¦ç‰¹æ€§

## å›žè°ƒå‡½æ•°

å¦‚æžœçœ‹è§æŸä¸ªå‡½æ•°å®šä¹‰é•¿ä¸‹é¢è¿™æ ·ðŸ‘‡é‚£å®ƒå°±åº”è¯¥æ˜¯ä¸ªå¸¦å›žè°ƒçš„å‡½æ•°ã€‚è¿™ç±»çš„å‡½æ•°ä¸€èˆ¬ä¸ºjså†…ç½®ï¼Œåœ¨è°ƒç”¨çš„æ—¶å€™éƒ½æ˜¯ä½œä¸ºä¸€ä¸ªæ–°çº¿ç¨‹è¿è¡Œçš„ã€‚

```javascript
function some_function(param1,param2,callback){}
```

callbacké‡Œé¢å†™ä¸Šä¸€ä¸ªè‡ªå·±å®šä¹‰çš„å‡½æ•°å‡½æ•°ï¼Œä¾‹å¦‚

```javascript
function another_function(err,data){}
```

ç„¶åŽè°ƒç”¨

```javascript
statement1

some_function(param1,param2,another_function)

statement2
```

é‚£ä¹ˆ`some_function`ä¼šå’Œ`statement2`å¹¶è¡Œæ‰§è¡Œï¼Œ`some_function`æ‰§è¡Œå®ŒåŽå°±ä¼šè°ƒç”¨`another_function`ç„¶åŽç»™`another_function`ä¼ ä¸¤ä¸ªä¸ªå‚æ•°`err`å’Œ`data`ã€‚nodejsä¸­å¸¦å›žè°ƒçš„å‡½æ•°éƒ½æŠŠé”™è¯¯ä¿¡æ¯ä½œä¸ºå›žè°ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¿”å›žçš„æ•°æ®ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚å›žè°ƒå‡½æ•°`another_function`ä¹Ÿå°†æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ã€‚

## äº‹ä»¶å¾ªçŽ¯

å¼•å…¥æ¨¡å—ðŸ‘‡åˆ›å»ºå¯¹è±¡ðŸ‘‡

```javascript
var events = require('events');
var eventEmitter = new events.EventEmitter();
```

æŠŠæŸä¸ªäº‹ä»¶`'eventName'`ç»‘å®šåˆ°æŸä¸ªå‡½æ•°`eventHandler`ä¸Š

```javascript
eventEmitter.on('eventName', eventHandler);
```

ç„¶åŽå°±å¯ä»¥è§¦å‘äº‹ä»¶äº†ðŸ‘‡

```javascript
eventEmitter.emit('eventName');
```

### è§¦å‘äº‹ä»¶çš„å†…éƒ¨æœºåˆ¶æ˜¯ï¼Ÿ

![äº‹ä»¶å¾ªçŽ¯](i/nodejs_1.jpg)

äº‹ä»¶å¾ªçŽ¯ðŸ‘†æ¯æ¬¡`eventEmitter.emit`éƒ½ä¼šæœ‰ä¸€ä¸ªäº‹ä»¶åç§°ï¼ˆ'eventName'ï¼‰å…¥é˜Ÿåˆ—ï¼Œåœ¨é˜Ÿåˆ—çš„å¦ä¸€ç«¯æ˜¯ä¸€ç¾¤å¤„ç†å‡½æ•°ï¼ˆeventHandlerï¼‰åœ¨ä¸æ–­ä»Žé˜Ÿåˆ—ä¸­å–äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚

### eventEmitterè¿˜æœ‰è¿™äº›åŠŸèƒ½ðŸ‘‡

```javascript
addListener(event, listener)
//ä¸ºæŒ‡å®šäº‹ä»¶æ·»åŠ ä¸€ä¸ªç›‘å¬å™¨åˆ°ç›‘å¬å™¨æ•°ç»„çš„å°¾éƒ¨ã€‚

on(event, listener)
//ä¸ºæŒ‡å®šäº‹ä»¶æ³¨å†Œä¸€ä¸ªç›‘å¬å™¨ï¼ŒæŽ¥å—ä¸€ä¸ªå­—ç¬¦ä¸² event å’Œä¸€ä¸ªå›žè°ƒå‡½æ•°ã€‚ 

once(event, listener)
//ä¸ºæŒ‡å®šäº‹ä»¶æ³¨å†Œä¸€ä¸ªå•æ¬¡ç›‘å¬å™¨ï¼Œå³ ç›‘å¬å™¨æœ€å¤šåªä¼šè§¦å‘ä¸€æ¬¡ï¼Œè§¦å‘åŽç«‹åˆ»è§£é™¤è¯¥ç›‘å¬å™¨ã€‚

removeListener(event, listener)
//ç§»é™¤æŒ‡å®šäº‹ä»¶çš„æŸä¸ªç›‘å¬å™¨ï¼Œç›‘å¬å™¨å¿…é¡»æ˜¯è¯¥äº‹ä»¶å·²ç»æ³¨å†Œè¿‡çš„ç›‘å¬å™¨ã€‚
å®ƒæŽ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯äº‹ä»¶åç§°ï¼Œç¬¬äºŒä¸ªæ˜¯å›žè°ƒå‡½æ•°åç§°ã€‚

removeAllListeners([event])
//ç§»é™¤æ‰€æœ‰äº‹ä»¶çš„æ‰€æœ‰ç›‘å¬å™¨ï¼Œ å¦‚æžœæŒ‡å®šäº‹ä»¶ï¼Œåˆ™ç§»é™¤æŒ‡å®šäº‹ä»¶çš„æ‰€æœ‰ç›‘å¬å™¨ã€‚

setMaxListeners(n)
//é»˜è®¤æƒ…å†µä¸‹ï¼Œ EventEmitters å¦‚æžœä½ æ·»åŠ çš„ç›‘å¬å™¨è¶…è¿‡ 10 ä¸ªå°±ä¼šè¾“å‡ºè­¦å‘Šä¿¡æ¯ã€‚ setMaxListeners å‡½æ•°ç”¨äºŽæé«˜ç›‘å¬å™¨çš„é»˜è®¤é™åˆ¶çš„æ•°é‡ã€‚

emit(event, [arg1], [arg2], [...])
//æŒ‰ç›‘å¬å™¨çš„é¡ºåºæ‰§è¡Œæ‰§è¡Œæ¯ä¸ªç›‘å¬å™¨ï¼Œå¦‚æžœäº‹ä»¶æœ‰æ³¨å†Œç›‘å¬è¿”å›ž trueï¼Œå¦åˆ™è¿”å›ž falseã€‚

listenerCount(emitter, event)
//è¿”å›žæŒ‡å®šäº‹ä»¶çš„ç›‘å¬å™¨æ•°é‡ã€‚
```

### ç»§æ‰¿ EventEmitter

å¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬ä¸ä¼šç›´æŽ¥ä½¿ç”¨ EventEmitterï¼Œè€Œæ˜¯åœ¨å¯¹è±¡ä¸­ç»§æ‰¿å®ƒã€‚

åŒ…æ‹¬ fsã€netã€ http åœ¨å†…çš„ï¼Œåªè¦æ˜¯æ”¯æŒäº‹ä»¶å“åº”çš„æ ¸å¿ƒæ¨¡å—éƒ½æ˜¯ EventEmitter çš„å­ç±»ã€‚

ä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼ŸåŽŸå› æœ‰ä¸¤ç‚¹ï¼š

* å…·æœ‰æŸä¸ªå®žä½“åŠŸèƒ½çš„å¯¹è±¡å®žçŽ°äº‹ä»¶ç¬¦åˆè¯­ä¹‰ï¼Œ äº‹ä»¶çš„ç›‘å¬å’Œå‘ç”Ÿåº”è¯¥æ˜¯ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•ã€‚

* JavaScript çš„å¯¹è±¡æœºåˆ¶æ˜¯åŸºäºŽåŽŸåž‹çš„ï¼Œæ”¯æŒéƒ¨åˆ†å¤šé‡ç»§æ‰¿ï¼Œç»§æ‰¿EventEmitter ä¸ä¼šæ‰“ä¹±å¯¹è±¡åŽŸæœ‰çš„ç»§æ‰¿å…³ç³»ã€‚

## å‡½æ•°orç±»ï¼Ÿ

1. æŽ¥ä¸‹æ¥æˆ‘è¦è¯´çš„äº‹ï¼Œä½ ä»¬åƒä¸‡åˆ«å®³æ€•
2. æ”¾å¿ƒï¼Œæˆ‘ä»¬æ˜¯ä¸“ä¸šç¨‹åºå‘˜ï¼Œæˆ‘ä»¬ä¸ä¼šæ€•ï¼Œä½ è¯·è¯´
3. æˆ‘åˆšæ‰ï¼Œåœ¨expressæºç é‡Œé¢çœ‹è§å‡ ä¸ªç±»æˆå‘˜è¢«å®šä¹‰åœ¨äº†ä¸€ä¸ªå‡½æ•°ä¸Šé¢ðŸ‘‡

```javascript
var proto = module.exports = function(options) {
  var opts = options || {};

  function router(req, res, next) {
    router.handle(req, res, next);
  }

  // mixin Router class functions
  setPrototypeOf(router, proto)

  router.params = {};
  router._params = [];
  router.caseSensitive = opts.caseSensitive;
  router.mergeParams = opts.mergeParams;
  router.strict = opts.strict;
  router.stack = [];

  return router;
};
```

4. ç±»æˆå‘˜è¢«å®šä¹‰åœ¨å‡½æ•°ä¸Šé¢æ˜¯ä»€ä¹ˆç±»
5. ä¸æ˜¯ä»€ä¹ˆç±»ï¼æ˜¯é‚£ç§ä¸€åŠå‡½æ•°ä¸€åŠç±»çš„å¥‡è‘©å˜é‡ï¼
6. ç”»ç”»ç”»ðŸ‘‡

```javascript
()=>{}
```

7. ä¸æ˜¯å‡½æ•°ï¼Œæœ‰æˆå‘˜å˜é‡çš„ï¼
8. ç”»ç”»ç”»ðŸ‘‡

```javascript
function R()={
    let r = {};
    r.rr = "rrr";
    return r;
}

R()
```

9. å°±æ˜¯é‚£ç§ï¼Œåˆèƒ½å½“å‡½æ•°ï¼Œåˆèƒ½å½“ç±»ç”¨çš„ï¼Œé‚£ç§å¥‡è‘©å˜é‡
10. å“ˆå“ˆå“ˆ
11. ......

å‡½æ•°å½“ç±»ç”¨ï¼ŒåŽŸåž‹æ¨¡å¼çœŸæ˜¯ç¼–ç¨‹è¯­è¨€ç•Œä¸€æœµå¥‡è‘©ã€‚

![å¥‡è‘©](i/nodejs_2.jpg)

## åœ¨å¾ªçŽ¯é‡Œé¢ç”¨åŒ¿åå‡½æ•°

ç¬”è€…å†™ä¸­é—´ä»¶è°ƒç”¨é“¾è¢«é€¼æ— èµ–å†™å‡ºäº†å¦‚ä¸‹ä»£ç ðŸ‘‡

```javascript
function next(f){f()}
let fun=()=>{console.log("I'm the last")};
for(let i=0;i<10;i++)
    fun=()=>{console.log(i);next(fun);}
fun()
```

é‚£ä¹ˆè¯·é—®ï¼Œè¿™æ®µä»£ç è¾“å‡ºä»€ä¹ˆï¼Ÿ

æ˜¯123456789åŠ ä¸€ä¸ªI'm the lastå—ï¼Ÿ

ä¸ï¼æ˜¯ï¼

å®ƒï¼å±…ç„¶ï¼è¾“å‡ºäº†ï¼æ ˆæº¢å‡ºï¼

åŽŸå› å±…ç„¶æ˜¯ï¼funå’Œcallç›¸äº’é€’å½’ï¼

![å¥‡è‘©](i/nodejs_3.png)

ä¼¼ä¹ŽåŒ¿åå‡½æ•°å˜é‡å¹¶ä¸èƒ½å’Œæ™®é€šå˜é‡ç­‰åŒã€‚

æƒ³è¦å®žçŽ°åƒä¸Šé¢é‚£ç§å‡½æ•°çƒ¤ä¸²ï¼Œæ­£ç¡®çš„åšæ³•æ˜¯æ¯ä¸€å±‚éƒ½ç»™ä¸€ä¸ªå•ç‹¬çš„å˜é‡ðŸ‘‡

```javascript
function next(f){f()}
let funs=[];
funs[10]=()=>{console.log("I'm the last")};
for(let i=0;i<10;i++)
    funs[i]=()=>{console.log(i);next(funs[i+1]);}
funs[0]()
```
