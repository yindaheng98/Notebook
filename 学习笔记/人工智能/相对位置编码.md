# 相对位置编码

原论文：

P. Shaw, J. Uszkoreit, and A. Vaswani, ‘Self-Attention with Relative Position Representations’, in Proceedings of the 2018 Conference of the North American Chapter of the Association for Computational Linguistics: Human Language Technologies, Volume 2 (Short Papers), New Orleans, Louisiana, 2018, pp. 464–468. doi: 10.18653/v1/N18-2074.

## 没有位置编码的Attention

设$d_z$表示输入和输出特征的维度，$i\in[1,n]$，$n$表示输入样本数量。输入向量组成矩阵$X\in\mathbb R^{n\times d_z}$。

那么输出矩阵$Z\in\mathbb R^{n\times d_z}$计算过程为：

$$
Z=softmax(\frac{(X W^Q)(X W^K)^T}{\sqrt{d_z}})(X W^V)
$$

其中$W^Q\in\mathbb R^{d_{model}\times d_z}$、$W^K\in\mathbb R^{d_{model}\times d_z}$、$W^V\in\mathbb R^{d_{model}\times d_z}$

为了解释相对位置编码，将计算过程展开，输入向量$\bm x_i\in\mathbb R^{d_z}$：

$$\begin{aligned}
Z
&=softmax\left(\frac{\left[\begin{gathered}x_1\\\vdots\\x_n\end{gathered}\right]\cdot W^Q\cdot (\left[\begin{gathered}x_1\\\vdots\\x_n\end{gathered}\right]\cdot W^K)^T}{\sqrt{d_z}}\right)\cdot \left[\begin{gathered}x_1\\\vdots\\x_n\end{gathered}\right]\cdot W^V\\
&=softmax\left(\frac{\left[\begin{gathered}x_1 W^Q\\\vdots\\x_n W^Q\end{gathered}\right]\left[\begin{gathered}x_1 W^K\\\vdots\\x_n W^K\end{gathered}\right]^T}{\sqrt{d_z}}\right)\left[\begin{gathered}x_1 W^V\\\vdots\\x_n W^V\end{gathered}\right]\\
&=softmax\left(\frac{(\left[\begin{gathered}x_1 W^Q\\\vdots\\x_iW^Q\\\vdots\\x_n W^Q\end{gathered}\right])\left[\begin{gathered}(x_1 W^K)^T,\dots,(x_jW^K)^T\dots,(x_n W^K)^T\end{gathered}\right]}{\sqrt{d_z}}\right)\left[\begin{gathered}x_1 W^V\\\vdots\\x_jW^V\\\vdots\\x_n W^V\end{gathered}\right]\\
&=softmax\left(\frac{\left\{x_i W^Q(x_j W^K)^T\right\}_{i,j\in[1,n]}}{\sqrt{d_z}}\right)\left[\begin{gathered}x_1 W^V\\\vdots\\x_jW^V\\\vdots\\x_n W^V\end{gathered}\right]\\
&=\left\{softmax\left(\frac{x_i W^Q(x_j W^K)^T}{\sqrt{d_z}}\right)\right\}_{i,j\in[1,n]}\left[\begin{gathered}x_1 W^V\\\vdots\\x_jW^V\\\vdots\\x_n W^V\end{gathered}\right]\\
&=\left[\sum_{j=1}^nsoftmax\left(\frac{x_i W^Q(x_j W^K)^T}{\sqrt{d_z}}\right)x_j W^V\right]_{i\in[1,n]}\\
&=\left[\begin{gathered}z_1\\\vdots\\z_n\end{gathered}\right]
\end{aligned}$$

所以：
$$
z_i=\sum_{j=1}^nsoftmax\left(\frac{x_i W^Q(x_j W^K)^T}{\sqrt{d_z}}\right)x_j W^V
$$

## 加上相对位置编码的Attention

$$
z_i=\sum_{j=1}^nsoftmax\left(\frac{x_i W^Q(x_j W^K+a_{ij}^K)^T}{\sqrt{d_z}}\right)(x_j W^V+a_{ij}^V)
$$

其中，$a_{ij}^K$和$a_{ij}^V$就是序列中的元素$i$相对于元素$j$的相对位置编码。进一步，这两项位置编码值都取自长为$2k+1$的位置编码集：

$$
\begin{aligned}
w^K&=(w_{-k}^K,\dots,w_k^K)\\
w^V&=(w_{-k}^V,\dots,w_k^V)
\end{aligned}
$$

其取法如下：

$$
\begin{aligned}
a_{ij}^K&=w_{clip}^K(j-i,k)\\
a_{ij}^V&=w_{clip}^V(j-i,k)\\
clip(x,k)&=max(-k,min(k,x))
\end{aligned}
$$

其实就是根据$ij$差值去$w^K$和$w^V$里取值，并且设定差值最大为$k$，超过$k$的位置编码为固定值。

也挺好理解的。

## 相对位置编码的矩阵形式

$$\begin{aligned}
Z
&=\left[\begin{gathered}z_1\\\vdots\\z_n\end{gathered}\right]\\
&=\left[\sum_{j=1}^nsoftmax\left(\frac{x_i W^Q(x_j W^K+a_{ij}^K)^T}{\sqrt{d_z}}\right)(x_j W^V+a_{ij}^V)\right]_{i\in[1,n]}\\
&=\left[\sum_{j=1}^nsoftmax\left(\frac{x_i W^Q(x_j W^K)^T+x_i W^Q(a_{ij}^K)^T}{\sqrt{d_z}}\right)(x_j W^V+a_{ij}^V)\right]_{i\in[1,n]}
\end{aligned}$$

这么一看$a_{ij}^K$和$a_{ij}^V$都是向量，那由$a_{ij}^K$和$a_{ij}^V$组成的矩阵就是个$\mathbb R^{n\times n\times d_z}$的三维矩阵了，没法表示啊😂，还是算了吧