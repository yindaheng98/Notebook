# ç›¸å¯¹ä½ç½®ç¼–ç 

åŸè®ºæ–‡ï¼š

P. Shaw, J. Uszkoreit, and A. Vaswani, â€˜Self-Attention with Relative Position Representationsâ€™, in Proceedings of the 2018 Conference of the North American Chapter of the Association for Computational Linguistics: Human Language Technologies, Volume 2 (Short Papers), New Orleans, Louisiana, 2018, pp. 464â€“468. doi: 10.18653/v1/N18-2074.

## æ²¡æœ‰ä½ç½®ç¼–ç çš„Attention

è®¾$d_z$è¡¨ç¤ºè¾“å…¥å’Œè¾“å‡ºç‰¹å¾çš„ç»´åº¦ï¼Œ$i\in[1,n]$ï¼Œ$n$è¡¨ç¤ºè¾“å…¥æ ·æœ¬æ•°é‡ã€‚è¾“å…¥å‘é‡ç»„æˆçŸ©é˜µ$X\in\mathbb R^{n\times d_z}$ã€‚

é‚£ä¹ˆè¾“å‡ºçŸ©é˜µ$Z\in\mathbb R^{n\times d_z}$è®¡ç®—è¿‡ç¨‹ä¸ºï¼š

$$
Z=softmax(\frac{(X W^Q)(X W^K)^T}{\sqrt{d_z}})(X W^V)
$$

å…¶ä¸­$W^Q\in\mathbb R^{d_{model}\times d_z}$ã€$W^K\in\mathbb R^{d_{model}\times d_z}$ã€$W^V\in\mathbb R^{d_{model}\times d_z}$

ä¸ºäº†è§£é‡Šç›¸å¯¹ä½ç½®ç¼–ç ï¼Œå°†è®¡ç®—è¿‡ç¨‹å±•å¼€ï¼Œè¾“å…¥å‘é‡$\bm x_i\in\mathbb R^{d_z}$ï¼š

$$\begin{aligned}
Z
&=softmax\left(\frac{\left[\begin{gathered}x_1\\\vdots\\x_n\end{gathered}\right]\cdot W^Q\cdot (\left[\begin{gathered}x_1\\\vdots\\x_n\end{gathered}\right]\cdot W^K)^T}{\sqrt{d_z}}\right)\cdot \left[\begin{gathered}x_1\\\vdots\\x_n\end{gathered}\right]\cdot W^V\\
&=softmax\left(\frac{\left[\begin{gathered}x_1 W^Q\\\vdots\\x_n W^Q\end{gathered}\right]\left[\begin{gathered}x_1 W^K\\\vdots\\x_n W^K\end{gathered}\right]^T}{\sqrt{d_z}}\right)\left[\begin{gathered}x_1 W^V\\\vdots\\x_n W^V\end{gathered}\right]\\
&=softmax\left(\frac{(\left[\begin{gathered}x_1 W^Q\\\vdots\\x_iW^Q\\\vdots\\x_n W^Q\end{gathered}\right])\left[\begin{gathered}(x_1 W^K)^T,\dots,(x_jW^K)^T\dots,(x_n W^K)^T\end{gathered}\right]}{\sqrt{d_z}}\right)\left[\begin{gathered}x_1 W^V\\\vdots\\x_jW^V\\\vdots\\x_n W^V\end{gathered}\right]\\
&=softmax\left(\frac{\left\{x_i W^Q(x_j W^K)^T\right\}_{i,j\in[1,n]}}{\sqrt{d_z}}\right)\left[\begin{gathered}x_1 W^V\\\vdots\\x_jW^V\\\vdots\\x_n W^V\end{gathered}\right]\\
&=\left\{softmax\left(\frac{x_i W^Q(x_j W^K)^T}{\sqrt{d_z}}\right)\right\}_{i,j\in[1,n]}\left[\begin{gathered}x_1 W^V\\\vdots\\x_jW^V\\\vdots\\x_n W^V\end{gathered}\right]\\
&=\left[\sum_{j=1}^nsoftmax\left(\frac{x_i W^Q(x_j W^K)^T}{\sqrt{d_z}}\right)x_j W^V\right]_{i\in[1,n]}\\
&=\left[\begin{gathered}z_1\\\vdots\\z_n\end{gathered}\right]
\end{aligned}$$

æ‰€ä»¥ï¼š
$$
z_i=\sum_{j=1}^nsoftmax\left(\frac{x_i W^Q(x_j W^K)^T}{\sqrt{d_z}}\right)x_j W^V
$$

## åŠ ä¸Šç›¸å¯¹ä½ç½®ç¼–ç çš„Attention

$$
z_i=\sum_{j=1}^nsoftmax\left(\frac{x_i W^Q(x_j W^K+a_{ij}^K)^T}{\sqrt{d_z}}\right)(x_j W^V+a_{ij}^V)
$$

å…¶ä¸­ï¼Œ$a_{ij}^K$å’Œ$a_{ij}^V$å°±æ˜¯åºåˆ—ä¸­çš„å…ƒç´ $i$ç›¸å¯¹äºå…ƒç´ $j$çš„ç›¸å¯¹ä½ç½®ç¼–ç ã€‚è¿›ä¸€æ­¥ï¼Œè¿™ä¸¤é¡¹ä½ç½®ç¼–ç å€¼éƒ½å–è‡ªé•¿ä¸º$2k+1$çš„ä½ç½®ç¼–ç é›†ï¼š

$$
\begin{aligned}
w^K&=(w_{-k}^K,\dots,w_k^K)\\
w^V&=(w_{-k}^V,\dots,w_k^V)
\end{aligned}
$$

å…¶å–æ³•å¦‚ä¸‹ï¼š

$$
\begin{aligned}
a_{ij}^K&=w_{clip}^K(j-i,k)\\
a_{ij}^V&=w_{clip}^V(j-i,k)\\
clip(x,k)&=max(-k,min(k,x))
\end{aligned}
$$

å…¶å®å°±æ˜¯æ ¹æ®$ij$å·®å€¼å»$w^K$å’Œ$w^V$é‡Œå–å€¼ï¼Œå¹¶ä¸”è®¾å®šå·®å€¼æœ€å¤§ä¸º$k$ï¼Œè¶…è¿‡$k$çš„ä½ç½®ç¼–ç ä¸ºå›ºå®šå€¼ã€‚

ä¹ŸæŒºå¥½ç†è§£çš„ã€‚

## ç›¸å¯¹ä½ç½®ç¼–ç çš„çŸ©é˜µå½¢å¼

$$\begin{aligned}
Z
&=\left[\begin{gathered}z_1\\\vdots\\z_n\end{gathered}\right]\\
&=\left[\sum_{j=1}^nsoftmax\left(\frac{x_i W^Q(x_j W^K+a_{ij}^K)^T}{\sqrt{d_z}}\right)(x_j W^V+a_{ij}^V)\right]_{i\in[1,n]}\\
&=\left[\sum_{j=1}^nsoftmax\left(\frac{x_i W^Q(x_j W^K)^T+x_i W^Q(a_{ij}^K)^T}{\sqrt{d_z}}\right)(x_j W^V+a_{ij}^V)\right]_{i\in[1,n]}
\end{aligned}$$

è¿™ä¹ˆä¸€çœ‹$a_{ij}^K$å’Œ$a_{ij}^V$éƒ½æ˜¯å‘é‡ï¼Œé‚£ç”±$a_{ij}^K$å’Œ$a_{ij}^V$ç»„æˆçš„çŸ©é˜µå°±æ˜¯ä¸ª$\mathbb R^{n\times n\times d_z}$çš„ä¸‰ç»´çŸ©é˜µäº†ï¼Œæ²¡æ³•è¡¨ç¤ºå•ŠğŸ˜‚ï¼Œè¿˜æ˜¯ç®—äº†å§