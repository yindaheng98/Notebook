# 投影和光栅化

## 齐次坐标

## 正交投影和透视投影

来两张图就看懂了：

![](i/20231221222409.png)

![](i/20231221222538.png)

正交投影是透视投影中相机无限远的特殊情况，没有了近大远小的效应。正交投影渲染方式也很简单，直接把z轴扔掉就行了：

![](i/20231221222846.png)

透视投影可以理解为将远处的平面挤压之后再做正交投影

![](i/projection1.png)

我们可以从直觉上规定这种挤压的规则：
* 近平面$z=n$上的点坐标不变
* 远平面$z=f$压缩后中心点坐标不变

这里注意，**我们无法再规定“各平面压缩后z轴坐标不变”**，虽然这样很符合直觉，但是**规定了这个的变换就不是线性变换了**，没法用一个矩阵表示。

设这个线性挤压的操作的变换矩阵为$M_{persp\rightarrow ortho}$，如何求？

如图所示，设近平面的z轴坐标为$n$，要将远处某平面上的坐标$[x,y,z]^T$进行挤压，仅从y轴坐标看，挤压操作会将$y$压缩到$y'=\frac{n}{z}y$：

![](i/proj2.png)

同理，挤压操作会将$x$压缩到$x'=\frac{n}{z}x$，由于没有规定“各平面压缩后z轴坐标不变”，变换后的z轴坐标不知道会变成什么样，先用“?”代替一下，于是可写出变换的结果：

$$
\left[
\begin{matrix}
    x\\y\\z\\1
\end{matrix}
\right]
\Rightarrow
\left[
\begin{matrix}
    \frac{n}{z}x\\\frac{n}{z}y\\?\\1
\end{matrix}
\right]
\quad z\in[n,f]
$$

由于是齐次坐标，所以全部乘上$z$也表示同一个点：

$$
\left[
\begin{matrix}
    x\\y\\z\\1
\end{matrix}
\right]
\Rightarrow
\left[
\begin{matrix}
    \frac{n}{z}x\\\frac{n}{z}y\\?\\1
\end{matrix}
\right]
\Rightarrow
\left[
\begin{matrix}
    nx\\ny\\?\\z
\end{matrix}
\right]
\quad z\in[n,f]
$$

再看规则“近平面$z=n$上的点坐标不变”，很显然可以表示为$z=n$平面上的点映射关系：

$$
\left[
\begin{matrix}
    x\\y\\n\\1
\end{matrix}
\right]
\Rightarrow
\left[
\begin{matrix}
    x\\y\\n\\1
\end{matrix}
\right]
\Rightarrow
\left[
\begin{matrix}
    nx\\ny\\n^2\\n
\end{matrix}
\right]
$$

再看规则“远平面$z=f$压缩后中心点坐标不变”，很显然可以表示为$z=n$平面上的原点映射关系：

$$
\left[
\begin{matrix}
    0\\0\\f\\1
\end{matrix}
\right]
\Rightarrow
\left[
\begin{matrix}
    0\\0\\f\\1
\end{matrix}
\right]
\Rightarrow
\left[
\begin{matrix}
    0\\0\\f^2\\f
\end{matrix}
\right]
$$

所以上面三个坐标映射关系可以写成$M_{persp\rightarrow ortho}$的一个方程：

$$
\left[
\begin{matrix}
    nx&nx_n&0\\ny&ny_n&0\\?&n^2&f^2\\z&n&f
\end{matrix}
\right]
=
M_{persp\rightarrow ortho}
\left[
\begin{matrix}
    x&x_n&0\\y&y_n&0\\z&n&f\\1&1&1
\end{matrix}
\right]
$$

很容易推导出$M_{persp\rightarrow ortho}$，在近远两平面之间的点映射后的z轴坐标也知道了：

$$
\left[
\begin{matrix}
    nx&nx_n&0\\ny&ny_n&0\\z(n+f)-nf&n^2&f^2\\z&n&f
\end{matrix}
\right]
=
\left[
\begin{matrix}
    n&0&0&0\\0&n&0&0\\0&0&n+f&-nf\\0&0&1&0
\end{matrix}
\right]
\left[
\begin{matrix}
    x&x_n&0\\y&y_n&0\\z&n&f\\1&1&1
\end{matrix}
\right]
$$

