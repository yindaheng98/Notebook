# 球谐系数与球面高斯

尽量不用各种术语来讲清楚SH(Spherical Harmonics)系数，以及SH在简单光照描述上的应用。

SH意指球谐函数，归根到底只是一组“基函数”，球谐系数就是这组基函数的系数。 

## 基函数

所谓“基函数”就是一组可以组成任意函数的分量。比如

比如泰勒展开以多项式函数系$\{1,x-x_0,(x-x_0)^2,(x-x_0)^3,\dots,y_{n}=(x-x_0)^n,\dots\}$为基函数，
在对函数$f(x)$的泰勒展开中：

$$
\begin{aligned}
f(x)&=\frac{f(x_0)}{0!}+\frac{f'(x_0)}{1!}(x-x_0)+\frac{f''(x_0)}{2!}(x-x_0)^2+\cdots+\frac{f^{(n)}(x_0)}{n!}(x-x_0)^n+\cdots\\
&=\sum_{n=0}^\infty\frac{f^{(n)}(x_0)}{n!}(x-x_0)^n
\end{aligned}
$$

$\{\frac{f(x_0)}{0!},\frac{f'(x_0)}{1!},\frac{f''(x_0)}{2!},\dots,\frac{f^{(n)}(x_0)}{n!},\dots\}$就是这组基函数的系数。

又比如傅里叶变换以三角函数系$\{1,\sin(\omega x),\cos(\omega x),\sin(2\omega x),\cos(2\omega x),\sin(3\omega x),\cos(3\omega x),\dots,\sin(n\omega x),\cos(n\omega x),\dots\}$作为基函数，在对函数$f(x)$的傅里叶展开中：

$$
\begin{aligned}
f(x)&=\frac{a_0}{2}+\sum_{n=1}^\infty\left(a_n\cos(n\omega x)+b_n\sin(n\omega x)\right)\\
&=\frac{a_0}{2}+a_1\cos(1\omega x)+b_1\sin(1\omega x)+a_2\cos(2\omega x)+b_2\sin(2\omega x)+\cdots+a_n\cos(n\omega x)+b_n\sin(n\omega x)+\cdots\\
a_n&=\frac{2}{T}\int_0^Tf(x)\cos(n\omega x)dt\\
b_n&=\frac{2}{T}\int_0^Tf(x)\sin(n\omega x)dt\\
\end{aligned}
$$

$\{\frac{a_0}{2},a_1,b_1,a_2,b_2,a_3,b_3,\dots,a_n,b_n,\dots\}$就是这组基函数的系数。

有了基函数，就可以把任意一个函数，描述成几个基函数的加权和了。 
当基函数用的个数越多，和原始函数本身也就越接近。 

这里用的是二维直角坐标系下的函数$y=f(x)$举例，而拓展到极坐标系函数$r=f(\theta)$也有多种基函数。
再扩展到三维坐标系下，函数函数$z=f(x,y)$表示一个平面，同样有二维傅里叶级数等二维基函数；而三维极坐标系即球面坐标系函数$r=f(\theta,\phi)$对应的则通常是一个凹凸不平的球面（半径$r$随方向角$(\theta,\phi)$变化且方向角范围为$[-\pi,\pi]$），也同理可以用一系列基函数近似表示，这些基函数称为“球面基函数”。

而球谐函数(Spherical Harmonics)就是最有名的球面基函数。球谐函数有很多很好的性质，比如正交性，旋转不变性，就和傅里叶级数里的基函数一样完美。

## 球谐函数

一般我们把球谐函数记为$Y_l^m$：

$$
Y_l^m(\theta,\phi)=
\left\{
\begin{aligned}
    &\sqrt2K_l^m\cos(m\phi)P_l^m(\cos\theta)&(m>0)\\
    &\sqrt2K_l^m\cos(-m\phi)P_l^{-m}(\cos\theta)&(m<0)\\
    &K_l^0P_l^0(\cos\theta)&(m=0)
\end{aligned}
\right.
$$

其中，$l\in\mathbb N$称为球谐函数的“次数”、$m\in\mathbb Z,m\in[-l,l]$称为球谐函数的“阶数”、
$K_l^m$是一个缩放系数，和归一化有关：

$$
K_l^m=\sqrt{\frac{2l+2}{4\pi}\cdot\frac{(l-|m|)!}{(l+|m|)!}}
$$

$P_l^m(\cdot)$为[勒让德多项式](https://zh.wikipedia.org/wiki/%E5%8B%92%E8%AE%A9%E5%BE%B7%E5%A4%9A%E9%A1%B9%E5%BC%8F)，是勒让德微分方程的解：

$$(1-x^{2}){\frac {\mathrm {d} ^{2}P(x)}{\mathrm {d} x^{2}}}-2x{\frac {\mathrm {d} P(x)}{\mathrm {d} x}}+n(n+1)P(x)=0$$

上述方程及其解函数因法国数学家阿德里安-马里·勒让德而得名。勒让德方程是物理学和其他技术领域常常遇到的一类常微分方程。当试图在球坐标中求解三维拉普拉斯方程（或相关的其他偏微分方程）时，问题便会归结为勒让德方程的求解。

此处出现勒让德多项式的主要原因是因为勒让德多项式的正交性，它的正交性给球谐函数带来了正交性，使其成为和三角函数系一样完美的基函数系。

第一次看完表达式之后的心情一般如下 

![](zhimg.com/v2-6540b01fe06220d21a78870a89a46e06_b.jpg)

球谐函数的各基函数化成图长这样：

![](zhimg.com/v2-1ea9c5bac926b47e7410a4a73a91070a_r.jpg)

其中蓝色表示$Y_l^m(\theta,\phi)$值为正数，黄色表示$Y_l^m(\theta,\phi)$值为负数，从上到下次数增大，从左到右阶数增大：

其实退化到二维来看，还是很简单的，二维的SH差不多长这样，蓝色表示$Y_l^m(\theta,\phi)$值为正数，黄色表示$Y_l^m(\theta,\phi)$值为负数： 

（具体系数不太准确仅用于示意...） 

![](zhimg.com/v2-a23b03aaed71ad57e133211ef4d19afe_r.jpg)

像这样是不是就特别简单了，em，看这个波瓣长得似乎有点三维SH的意思了嘛。 

（可以思考一个小问题：为啥二维情况下第三排的基函数只有cos平方，没有sin平方呢？） 

假如有一个极坐标的函数长这样： 

![](zhimg.com/v2-2942f917515e32af8d65d75ea85cc27b_r.jpg)

他可以表示为 

$$r = 0.5 + 0.1 \cos\theta + 0.07 \sin\theta + 0.05 \cos\theta \sin\theta + 0.3(2\cos^2\theta - 1)$$

只记球谐系数，这个函数就表示为$0.5,0.1,0.07,0.05,0.3$。

回到三维的情况这几个数字其实就是SH系数啦。 

当SH的系数用的越多，那么表达能力就越强，跟原始的函数就越接近：

![](zhimg.com/v2-447fa3cffce97c4d95fd924c3e4ce5b9_r.jpg)

## 球谐函数的图形学应用

在图形学中，球谐函数通常用来记录某个值在球面上的分布，比如光照情况或颜色分布等。

例如，用平面来表示的一球坐标系函数$r=f(\theta,\phi)$可能长这样：

![](zhimg.com/v2-17b532bdb46a0d30b9eaf0e45f2df733_b.jpg)

用$r$表示亮度的话就是一个球体上的高光：

![](zhimg.com/v2-663f3ac6abb50526a2019acb0c1b28b0_r.jpg)

同理，三个球坐标系函数也可以用来表示球面上不同位置有不同的颜色。
而理论上任意的球坐标系函数都可以分解成球谐函数之和，所以只要记下了球谐系数等于记下了球面上的光照情况。

此外，球谐函数还可用于记录空间中某个点从不同方向看过去的不同颜色，这在点云渲染中非常有用，[3D Gaussian Splatting](./3DGaussianSplatting.md)就是用球谐函数记录空间中的Gaussian点在不同方向的颜色。

实际应用中的球谐函数基函数一般只用到二阶或三阶。
二阶是4个系数，拓展到rgb，每个颜色通道一个系数，就是4 * 3 = 12个系数。
三阶是9个系数，拓展到rgb就是9 * 3 = 27个系数。

为啥不用更高阶的SH？一方面是因为更多的系数会带来更大的存储压力、计算压力，而一般描述变化比较平滑的环境漫反射部分，用3阶SH就足够了；另一方面则是因为SH的物理含义不是特别好理解，高阶SH容易出现各种花式Artifact，美术同学一般都会认为这种表现属于bug。 

![](zhimg.com/v2-70396fd2f0a9c3d2842a0c1dae9bfadf_r.jpg)

那有没有更直观物理含义更好理解的基函数的？也有的，比如SG

[浦夜：球面高斯介绍（Spherical Gaussian）](https://zhuanlan.zhihu.com/p/514017351)