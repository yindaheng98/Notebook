# 3D Gaussian Splatting核心CUDA代码注释：反向传播部分（二）`BACKWARD::preprocess`

先看[上一节](./3D高斯反向传播代码解析.md)

## 对预处理过程的反向传播`BACKWARD::preprocess`

计算每一个高斯球投影出来的圆半径及覆盖的范围。

```cpp
void BACKWARD::preprocess(
	int P, int D, int M,
	const float3* means3D,
	const int* radii,
	const float* shs,
	const bool* clamped,
	const glm::vec3* scales,
	const glm::vec4* rotations,
	const float scale_modifier,
	const float* cov3Ds,
	const float* viewmatrix,
	const float* projmatrix,
	const float focal_x, float focal_y,
	const float tan_fovx, float tan_fovy,
	const glm::vec3* campos,
	const float3* dL_dmean2D, // 高斯球投影在像平面上的2D均值位置的梯度（BACKWARD::render的计算结果）
	const float* dL_dconic, // 高斯球投影在像平面上的2D协方差矩阵（不叠加透明度）的梯度（BACKWARD::render的计算结果）
	glm::vec3* dL_dmean3D, // 高斯球3D均值位置的梯度（待求解）
	float* dL_dcolor, // 高斯球颜色的梯度（BACKWARD::render的计算结果）
	float* dL_dcov3D, // 高斯球3D协方差矩阵的梯度（待求解）
	float* dL_dsh, // 高斯球球谐系数的梯度（待求解）
	glm::vec3* dL_dscale, // 高斯球scale参数的梯度（待求解）
	glm::vec4* dL_drot) // 高斯球rotation参数的梯度（待求解）
{
	// Propagate gradients for the path of 2D conic matrix computation. 
	// Somewhat long, thus it is its own kernel rather than being part of 
	// "preprocess". When done, loss gradient w.r.t. 3D means has been
	// modified and gradient w.r.t. 3D covariance matrix has been computed.	
	computeCov2DCUDA << <(P + 255) / 256, 256 >> > (
		P,
		means3D,
		radii,
		cov3Ds,
		focal_x,
		focal_y,
		tan_fovx,
		tan_fovy,
		viewmatrix,
		dL_dconic,
		(float3*)dL_dmean3D,
		dL_dcov3D);

	// Propagate gradients for remaining steps: finish 3D mean gradients,
	// propagate color gradients to SH (if desireD), propagate 3D covariance
	// matrix gradients to scale and rotation.
	preprocessCUDA<NUM_CHANNELS> << < (P + 255) / 256, 256 >> > (
		P, D, M,
		(float3*)means3D,
		radii,
		shs,
		clamped,
		(glm::vec3*)scales,
		(glm::vec4*)rotations,
		scale_modifier,
		projmatrix,
		campos,
		(float3*)dL_dmean2D,
		(glm::vec3*)dL_dmean3D,
		dL_dcolor,
		dL_dcov3D,
		dL_dsh,
		dL_dscale,
		dL_drot);
}
```