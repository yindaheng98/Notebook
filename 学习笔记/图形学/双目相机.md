# 双目视觉模型

任务|场景数据|相机数据|输入|输出
-|-|-|-|-
Pose Estimation|已知|测得|相机视野内各点位置|相机位姿
Triangulation|测得|已知|相机位姿和相机视野内2D图片|相机视野内各点位置
Reconstruction|测得|测得|相机视野内2D图片|相机视野内各点位置

## 三角化 Triangulation

Triangulation解决的是从两张图片中计算对应点的三维坐标的问题。

这个问题的假设是：

* 两张图片对应的相机内参和外参都是已知的
* 相机中对应点关系是已知的并且正确的

这样我们就可以从这两张图片中计算出指向该点方向的两条光线，进而求其交点就得这个点对应的三维坐标

![](zhimg.com/v2-e30183f32a92f517970dad22c435100c_r.jpg)

## 理想情况的三角化 triangulation in simplified case

我们首先研究简化的情况，这个情况的假设就是两个相机的内参矩阵是 **完全一样** 的，而且两个相机 **在x方向是完全对齐的。** 

这样我们就可以有如下的模型。

![](zhimg.com/v2-d63fa6da94ed40f8756fd5d87846d06e_r.jpg)

其中b被称为baseline，代表的是两个相机的光心对应的距离。图中分别以$C_lP$和$C_rP$为斜边可见左右两个直角三角形，其直角边可以写出如下的关系式：

$$
\begin{aligned}
    \frac{f}{Z_P}&=\frac{u_l}{X_P}&\text{(left image)}\\
    \frac{f}{Z_P}&=\frac{-u_r}{b-X_P}&\text{(right image)}\\
\end{aligned}
$$

左图公式写为：
$$X_p=\frac{u_lZ_P}{f}$$

带入右图公式：
$$\frac{f}{Z_P}=\frac{-u_r}{b-\frac{u_lZ_P}{f}}$$

解得：
$$Z_P=\frac{bf}{u_l-u_r}$$

进一步解得：
$$X_P=\frac{bu_l}{u_l-u_r}$$

而已知了$Z_P$，$Y_P$也就好解了：

![](i/stereo1.png)

很显然左右两图中看目标点在y轴上的位置应该是一样的，即$v_l=v_r$，这里以$v_l$为准：

$$Y_P=\frac{v_lZ_P}{f}$$

我们管  $u_l-u_r$  叫做“disparity”。其最大值就是图像本身的宽度，所以三角测量法存在一个最近距离，比最近距离还近的点无法同时出现在左右两图中所以没法三角测量。而对于无穷远的点，disparity=0.

## 带误差的三角化 triangulation in general case

理想情况的三角化很好，但是在现实生活中，由于生产和装配误差，再好的双目相机，两个相机之间也不可能是完全对齐的。

## stereo rectification

根据上面triangulation和对极约束的分析，我们可以看到，完全平行的双目相机计算是很有优势的。

其极线全都是相同位置的水平直线，在triangulation的时候也不再需要求解SVD之类的麻烦东西了。
所以我们就希望想方法，将拍到的图像投影到一个这样理想的双目相机模型中，这个过程就叫做stereo rectification.

![](i/stereo2.png)