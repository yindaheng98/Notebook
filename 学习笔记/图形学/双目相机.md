# 双目视觉模型

任务|场景数据|相机数据|输入|输出
-|-|-|-|-
Pose Estimation|已知|测得|相机视野内各点位置|相机位姿
Triangulation|测得|已知|相机位姿和相机视野内2D图片|相机视野内各点位置
Reconstruction|测得|测得|相机视野内2D图片|相机视野内各点位置

## 三角化 Triangulation

Triangulation解决的是从两张图片中计算对应点的三维坐标的问题。

这个问题的假设是：

* 两张图片对应的相机内参和外参都是已知的
* 相机中对应点关系是已知的并且正确的

这样我们就可以从这两张图片中计算出指向该点方向的两条光线，进而求其交点就得这个点对应的三维坐标

![](zhimg.com/v2-e30183f32a92f517970dad22c435100c_r.jpg)

## 理想情况的三角化 triangulation in simplified case

我们首先研究简化的情况，这个情况的假设就是两个相机的内参矩阵是 **完全一样** 的，而且两个相机 **在x方向是完全对齐的。** 

这样我们就可以有如下的模型。

![](zhimg.com/v2-d63fa6da94ed40f8756fd5d87846d06e_r.jpg)

其中b被称为baseline，代表的是两个相机的光心对应的距离。图中分别以$C_lP$和$C_rP$为斜边可见左右两个直角三角形，其直角边可以写出如下的关系式：

$$
\begin{aligned}
    \frac{f}{Z_P}&=\frac{u_l}{X_P}&\text{(left image)}\\
    \frac{f}{Z_P}&=\frac{-u_r}{b-X_P}&\text{(right image)}\\
\end{aligned}
$$

左图公式写为：
$$X_p=\frac{u_lZ_P}{f}$$

带入右图公式：
$$\frac{f}{Z_P}=\frac{-u_r}{b-\frac{u_lZ_P}{f}}$$

解得：
$$Z_P=\frac{bf}{u_l-u_r}$$

进一步解得：
$$X_P=\frac{bu_l}{u_l-u_r}$$

而已知了$Z_P$，$Y_P$也就好解了：

![](i/stereo1.png)

很显然左右两图中看目标点在y轴上的位置应该是一样的，即$v_l=v_r$，这里以$v_l$为准：

$$Y_P=\frac{v_lZ_P}{f}$$

我们管  $u_l-u_r$  叫做“disparity”。其最大值就是图像本身的宽度，所以三角测量法存在一个最近距离，比最近距离还近的点无法同时出现在左右两图中所以没法三角测量。而对于无穷远的点，disparity=0。

### 误差？

这里我们又注意到一个问题，disparity本身是由像素点估算出来的，像素有大小是离散的，势必会带来一些误差。我们用量化的方法研究一下 **baseline, disparity, 还有点的距离Z对误差的影响** 。

 $Z_P$  关于D是一个非线性函数，我们一般使用函数的一阶泰勒展开来估算函数自变量不确定性带来的因变量的不确定性

 $$ \Delta Z_P = \vert\frac{\mathrm{d}Z_p}{\mathrm{d}D}\vert \Delta D = |-\frac{bf}{D^2}|\Delta D \\$$  

如果我们将的表达式带入的话，可以得到

 $$ \Delta Z_P = |-\frac{Z_P^2}{bf}|\Delta D \\$$  

所以我们可以得出一下几个结论：

* 对于同一个3D点，disparity越大，误差越小
* 对于固定位置关系的两张图片，3D点离得越近误差越小


我们同时还可以总结一下baseline对他们的影响：

* b越大，triangulate的误差越小
* b越大，最近可测量距离变大


那么我们就知道怎样来提高双目相机系统的精度了：

* 增大baseline
* 增大焦距
* 尽量测量近距离的点

## 带误差的三角化 triangulation in general case

理想情况的三角化很好，但是在现实生活中，由于生产和装配误差，再好的双目相机，两个相机之间也不可能是完全对齐的，求出来的光线也不一定能精准相交。于是，我们需要在相没对齐光线也不能相交的情况下求解点的坐标：

![](zhimg.com/v2-8726fe92b71fd87f6d6b1db611aac2cb_r.jpg)

此时三角化问题描述为：
* 已知场景中的某个点在左侧和右侧相机照片上的位置分别为$(\bm x,\bm x')$
* 已知相机左右侧相机参数分别为$\bm P,\bm P'$
* 求该点在场景中的位置$X$

由于误差的存在，位置$X$不能精确求解，即$\bm x=\bm P\bm X$和$\bm x'=\bm P'\bm X$不能同时满足。
于是，三角化问题就成为了一个最优化问题，即：
$$\mathop{min}\limits_{\bm X} |\bm x-\bm P\bm X|+|\bm x-\bm P'\bm X|$$

回忆一下之前[相机参数与坐标系变换](./相机参数与坐标系变换.md)里讲的公式：

$$
z_p
\left[
    \begin{matrix}
        x\\y\\1
    \end{matrix}
\right]
=\bm P\cdot\bm X
=
\left[
    \begin{matrix}
        p_{11}&p_{12}&p_{13}&p_{14}\\p_{21}&p_{22}&p_{23}&p_{24}\\p_{31}&p_{32}&p_{33}&p_{34}
    \end{matrix}
\right]
\cdot
\left[
    \begin{matrix}
        x_w\\y_w\\z_w\\1
    \end{matrix}
\right]
$$


可拆为：

$$
\left\{
\begin{aligned}
    x&=\frac{1}{z_p}\bm p_1^T\cdot\bm X\\
    y&=\frac{1}{z_p}\bm p_2^T\cdot\bm X\\
    1&=\frac{1}{z_p}\bm p_3^T\cdot\bm X\\
\end{aligned}
\right.
$$

式1,2两边均乘上式3，可得两个约束：

$$
\left\{
\begin{aligned}
    \frac{x}{z_p}\bm p_3^T\cdot\bm X&=\frac{1}{z_p}\bm p_1^T\cdot\bm X\\
    \frac{x}{z_p}\bm p_3^T\cdot\bm X&=\frac{1}{z_p}\bm p_2^T\cdot\bm X\\
\end{aligned}
\right.
\Rightarrow
\left\{
\begin{aligned}
    x\bm p_3^T\cdot\bm X&=\bm p_1^T\cdot\bm X\\
    y\bm p_3^T\cdot\bm X&=\bm p_2^T\cdot\bm X\\
\end{aligned}
\right.
$$

将约束写成线性方程形式：

$$
\left\{
\begin{aligned}
    \bm p_1^T\cdot\bm X&-x\bm p_3^T\cdot\bm X&=0\\
    \bm p_2^T\cdot\bm X&-y\bm p_3^T\cdot\bm X&=0\\
\end{aligned}
\right.
$$

相当于把$\bm p_1^T,\bm p_2^T,\bm p_3^T$排成一行$[\bm p_1^T,\bm p_2^T,\bm p_3^T]$进行矩阵乘，所以可以写成矩阵形式：

$$
[\bm p_1^T,\bm p_2^T,\bm p_3^T]
\cdot
\left[
    \begin{matrix}
        \bm X&\bm 0\\
        \bm 0&\bm X\\
        -x\bm X&-y\bm X\\
    \end{matrix}
\right]
=[0,0]
$$

转置一下：

$$
\left[
    \begin{matrix}
        \bm X^T&\bm 0&-x\bm X^T\\
        \bm 0&\bm X^T&-y\bm X^T\\
    \end{matrix}
\right]
\cdot
\left[
    \begin{matrix}
        \bm p_1\\\bm p_2\\\bm p_3
    \end{matrix}
\right]
=
\left[
    \begin{matrix}
        0\\0
    \end{matrix}
\right]
$$

和[相机参数与坐标系变换](./相机参数与坐标系变换.md)里讲的DLT一模一样了。
但不一样的是，这次是$\bm P$已知求解$\bm X$，所以：
* 不会有更多的$\bm X$，而是会有更多的$\bm P$组成方程
* $\bm X$有三个值要解，一个相机两个方程是无穷多解，两个相机四个方程就成了超定方程了

于是就解此超定方程：

$$
\left[
    \begin{matrix}
        \bm X^T&\bm 0&-x\bm X^T\\
        \bm 0&\bm X^T&-y\bm X^T\\
    \end{matrix}
\right]
\cdot
\left[
    \begin{matrix}
        \bm p_1&\bm p_1'\\\bm p_2&\bm p_2'\\\bm p_3&\bm p_3'\\
    \end{matrix}
\right]
=
\left[
    \begin{matrix}
        0&0\\0&0
    \end{matrix}
\right]
$$

应用SVD求解即可，稍复杂，略。

## 对极几何（Epipolar Geometry）

刚才说的是知道了内参外参和点的对应关系之后，怎样进行三角定位。那往回推一步，怎样找点之间的对应关系呢？

如果直接在两张图里面找对应提取关键点进行匹配，只有在左右两边都找到的关键点才有可能匹配成功。如果对任意一点进行匹配的话，马上就会变成一个对左右两张图片所有像素的穷举搜索，复杂度为$O(hwh'w')$，其中$h,w$和$h',w'$分别为左右两图片的长款。

在已知相对位姿的双目相机中，能不能简化一些？
能！现在有了相对的位姿约束，我们可以将这 **个二维的搜索问题，降低到一维。** 

![](zhimg.com/v2-b2f19f5a4f51a65765a7a3fd04754f5e_r.jpg)

已知相机位姿的情况下，**从左边相机中发出的指向某个特征点的射线在右边相机中的投影可以计算出来**，所以直接在这条投影线上搜索特征点即可。
两个相机之间的相对位姿，为我们提供了一个很好的先验知识。

## stereo rectification

根据上面triangulation和对极约束的分析，我们可以看到，完全平行的双目相机计算是很有优势的。

其极线全都是相同位置的水平直线，在triangulation的时候也不再需要求解SVD之类的麻烦东西了。
所以我们就希望想方法，将拍到的图像投影到一个这样理想的双目相机模型中，这个过程就叫做stereo rectification.

![](i/stereo2.png)